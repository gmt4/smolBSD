export CHOUPI=y

. /etc/include/choupi
. /etc/include/basicrc
. /etc/include/mount9p

# needed to fetch HTTPS
mount -t tmpfs -o -s1M tmpfs /etc/openssl
mount -t tmpfs -o -s32M tmpfs /tmp
cp /usr/share/examples/certctl/certs.conf /etc/openssl/
certctl rehash

cd /mnt
. tmp/build*

export ADDPKGS

# some packages *cough* node *cough* need more files
sysctl -w kern.maxfiles=20000

# MIMINIZE this image using sailor
if [ -n "$MINIMIZE" ] && [ -f service/${SERVICE}/sailor.conf ]; then
	if [ ! -d sailor ]; then
		echo "${WARN} maximum minimization asked but sailor not available"
		echo "${WARN} git clone https://github.com/NetBSDfr/sailor first!"
	else
		echo "${ARROW} preparing env for sailor"
		mount -t tmpfs -o -s100M tmpfs /var/db
		mount -t tmpfs -o -s20M tmpfs /var/run
		# backup raw packages for later build
		tar cfp /tmp/usrpkg.tgz /usr/pkg
		mount -t tmpfs -o -s300M tmpfs /usr/pkg
	fi
fi

echo "${ARROW} building $SERVICE image"
echo "${INFO} exported variables"
cat tmp/build*|sed "s/^/${WHITEBULLET} /"
make $(grep -v ADDPKGS tmp/build*|xargs) base
echo "${CHECK} build finished, Ctrl-A X to exit"
rm -f tmp/build*
cat
